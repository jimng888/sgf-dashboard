#!/usr/bin/env node
/**
 * Embeds views and public assets into JS modules for Cloudflare Worker (no filesystem).
 * Run: node scripts/embed-worker-assets.js
 * Output: lib/ and worker/lib/ views-embedded.mjs, static-embedded.mjs
 */
const fs = require('fs');
const path = require('path');

const root = path.join(__dirname, '..');
const workerLib = path.join(root, 'worker', 'lib');

function escapeForTemplateLiteral(str) {
  return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
}

// Views
const loginEjs = fs.readFileSync(path.join(root, 'views', 'login.ejs'), 'utf8');
const dashboardEjs = fs.readFileSync(path.join(root, 'views', 'dashboard.ejs'), 'utf8');
const viewsContent = `// Generated by scripts/embed-worker-assets.js - do not edit by hand
export const login = \`${escapeForTemplateLiteral(loginEjs)}\`;
export const dashboard = \`${escapeForTemplateLiteral(dashboardEjs)}\`;
`;
fs.writeFileSync(path.join(root, 'lib', 'views-embedded.mjs'), viewsContent);
fs.mkdirSync(workerLib, { recursive: true });
fs.writeFileSync(path.join(workerLib, 'views-embedded.mjs'), viewsContent);

// Static
const stylesCss = fs.readFileSync(path.join(root, 'public', 'styles.css'), 'utf8');
const appJsContent = fs.readFileSync(path.join(root, 'public', 'app.js'), 'utf8');
const staticContent = `// Generated by scripts/embed-worker-assets.js - do not edit by hand
export const stylesCss = \`${escapeForTemplateLiteral(stylesCss)}\`;
export const appJs = \`${escapeForTemplateLiteral(appJsContent)}\`;
`;
fs.writeFileSync(path.join(root, 'lib', 'static-embedded.mjs'), staticContent);
fs.writeFileSync(path.join(workerLib, 'static-embedded.mjs'), staticContent);

console.log('Embedded views and static into lib/ and worker/lib/');